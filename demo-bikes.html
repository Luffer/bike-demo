<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0; } 
       .mapIconLabelGreen { font-size: 10px; font-weight: bold; color: #003300; text-align: center; width: 32px; }
       .mapIconLabelRed { font-size: 10px; font-weight: bold; color: #FFCCCC; text-align: center; width: 32px; }
       #legend { background: white; padding: 10px; }
       #citypanel { position: absolute; top: 5px; left: 50%; margin-left: -180px; 
                    z-index: 5; background-color: #fff; padding: 5px; border: 1px solid #999; }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markerwithlabel/1.0.1/src/markerwithlabel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fast-json-patch/0.5.2/json-patch-duplex.min.js"></script>
    <script type="text/javascript">

      // ADD YOUR JCDECAUX API KEY PAIR HERE
      var jcDecauxAPIKey = "[YOUR_JCDECAUX_API_KEY]";

      var map;
      var stations = [];
      var markers = [];
      var infoWindows = [];
      var lastOpenedInfoWindow;
      var selectedCity = 'Lyon';
      var myEventSource;

      var citiesPositions = [];
      citiesPositions['Lyon']  = new google.maps.LatLng(45.750000,4.850000);
      citiesPositions['Rouen'] = new google.maps.LatLng(49.4431,1.0993);
      citiesPositions['Paris'] = new google.maps.LatLng(48.856614,2.352222);
      citiesPositions['Marseille'] = new google.maps.LatLng(43.296482,5.36978);
      citiesPositions['Toulouse'] = new google.maps.LatLng(43.604652,1.444209);
      citiesPositions['Luxembourg'] = new google.maps.LatLng(49.611621,6.131935);
      citiesPositions['Dublin'] = new google.maps.LatLng(53.349805,-6.26031);
      citiesPositions['Valence'] = new google.maps.LatLng(39.469908,-0.376288);
      
      //When the window is loaded, run the initialize function to setup the map
      google.maps.event.addDomListener(window, 'load', initialize);   

      function initialize() {
        var map_canvas = document.getElementById('map_canvas');
        var mapOptions = {
          zoom: 14,
          center: citiesPositions[selectedCity]
        }
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(document.getElementById('legend'));
        var bikeLayer = new google.maps.BicyclingLayer();
        bikeLayer.setMap(map);

        getDataFromAPI(selectedCity, jcDecauxAPIKey);
      }

      function getDataFromAPI(selectedCity, jcDecauxAPIKey) {
        var xmlhttp=new XMLHttpRequest();
        xmlhttp.open("GET","https://api.jcdecaux.com/vls/v1/stations?contract="
                          + selectedCity + "&apiKey="+ jcDecauxAPIKey);
        xmlhttp.send();

        xmlhttp.onreadystatechange=function() {
            // initialize your data with the initial snapshot
            stations = JSON.parse(xmlhttp.responseText);
            addMarkersToMap(stations);
            
          };
      }

      function changeCity() {
        stations = [];
        markers = [];
        infoWindows = [];

        selectedCity = document.getElementById('city').value;

        getDataFromAPI(selectedCity, jcDecauxAPIKey);

        //Pan map to new selected city
        map.panTo(citiesPositions[selectedCity]);
      }

      function refresh() {
        getDataFromAPI(selectedCity, jcDecauxAPIKey);
      }

      function addStationInfoWindow(index, marker) {
          var contentString;
          var infoWindow;
          var station = stations[index];

          infoWindow = new google.maps.InfoWindow({
            content: createWindowInfoContent(station)
          });

          //Creates the event listener for clicking the marker
          //and places the marker on the map
          google.maps.event.addListener(marker, 'click', function() {
            if(lastOpenedInfoWindow) lastOpenedInfoWindow.close();       
            infoWindow.open(map, marker);
            lastOpenedInfoWindow = infoWindow;
          });
          
          infoWindows.push(infoWindow);
      }

      function addMarkersToMap(stations) {
        for (var i = 0; i < stations.length; i++) { 
          var infoWindow;
          var station = stations[i];
          var stationLatlng = new google.maps.LatLng(station.position.lat,station.position.lng);
          var icon;

            //icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',          
          icon = (station.available_bikes === 0)?"img/cycling-red.png":"img/cycling-green.png";
          labelClass = (station.available_bikes === 0)?"mapIconLabelRed":"mapIconLabelGreen"
        
          var marker = new MarkerWithLabel({
            position: stationLatlng,
            map: map,
            icon: icon,
            draggable: false,
            raiseOnDrag: false,
            labelContent: ""+station.available_bikes,
            labelAnchor: new google.maps.Point(7, 33),
            labelClass: labelClass,
            labelInBackground: false
          });

          addStationInfoWindow(i, marker);
          markers.push(marker);
        }
      }

      function hasAvailableBikeOrDocks(patch) {
        return patch.path.indexOf('available_bikes') > 0;
      }

      function createWindowInfoContent(station){
        return '<div id="content">'+
              '<div id="siteNotice">'+
              '</div>'+
              '<h1 id="firstHeading" class="firstHeading">'+ station.name +'</h1>'+
              '<div id="bodyContent">'+
              '<p> Status: <b>' + station.status + '</b></p>' + 
              '<p> Available Bikes: <b>' + station.available_bikes + '</b></p>' + 
              '<p> Available Docks: <b>' + station.available_bike_stands + '</b></p>' +
              '<p><i>Brought to you by <a href="streamdata.io">streamdata.io</a></i>'+
              '</div>'+
              '</div>';
      }

      function printStation(station) {
        console.log('latitude: ' + station.position.lat);
        console.log('longitude: ' + station.position.lng);
        console.log('availableBikes: ' + station.available_bikes);
        console.log('availableDocks: ' + station.available_bike_stands);
        console.log('distance: ' + station.distance);
        console.log('name: ' + station.name);
        console.log('address: ' + station.address);
        console.log('status: ' + station.status);
        console.log('---------------------------');
      }

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="legend"><h3>Legend</h3>
      <div><img src="img/cycling-green.png"> Available bikes</div>
      <div><img src="img/cycling-red.png"> Empty stations</div>
      <div><img src="img/cycling-blue.png"> New bikes available</div>
    </div>
    <div id="citypanel">
      <b>City: </b>
      <select id="city" onchange="changeCity();">
        <option value="Lyon">Lyon</option>
        <option value="Rouen">Rouen</option>
        <option value="Marseille">Marseille</option>
        <option value="Toulouse">Toulouse</option>
        <option value="Luxembourg">Luxembourg</option>
        <option value="Dublin">Dublin</option>
        <option value="Valence">Valence</option>
      </select>
      <button id="refreshBtn" onclick="refresh();">Refresh</button>
    </div>
  </body>
</html>